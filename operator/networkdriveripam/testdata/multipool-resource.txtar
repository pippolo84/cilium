hive start

# Add an IP pool
k8s/add ippool.yaml

# Add a node requesting addresses from the pool
k8s/add node.yaml

# Wait some time for the controller to allocate a CIDR
sleep 200ms

# Check that a CIDR from the pool has been assigned to the node
k8s/get cilium.io.v2.ciliumnodes test-node -o actual.yaml
cmp expected.yaml actual.yaml

# ----

-- ippool.yaml --
apiVersion: cilium.io/v2alpha1
kind: CiliumResourceIPPool
metadata:
  name: green-pool
spec:
  ipv4:
    cidrs:
    - 10.10.0.0/16
    maskSize: 24

-- node.yaml --
apiVersion: cilium.io/v2
kind: CiliumNode
metadata:
  name: test-node
  labels:
    kubernetes.io/hostname: test-node
spec:
  ipam:
    resourcepools:
      requested:
        - pool: "green-pool"
          needed:
            ipv4-addrs: 4
-- expected.yaml --
apiVersion: cilium.io/v2
kind: CiliumNode
metadata:
  labels:
    kubernetes.io/hostname: test-node
  name: test-node
  resourceVersion: "3"
spec:
  alibaba-cloud: {}
  azure: {}
  encryption: {}
  eni: {}
  health: {}
  ingress: {}
  ipam:
    pools: {}
    resourcepools:
      allocated:
      - cidrs:
        - 10.10.0.0/24
        pool: green-pool
      requested:
      - needed:
          ipv4-addrs: 4
        pool: green-pool
status:
  alibaba-cloud: {}
  azure: {}
  eni: {}
  ipam:
    operator-status: {}
